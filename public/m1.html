<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>APlayer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./music/APlayer.min.css">
  <script src="./music/APlayer.min.js"></script>
  
  <script src="./localforage.min.js"></script>
  <script src="./log.js"></script>
  <style>
    .log {
      color: gray;
      border: 1px solid #e9e9e9;
    }

    .mb10 {
      margin-bottom: 10px;
    }

    .ml10 {
      margin-left: 10px;
    }

    .breakline {
      word-wrap:break-word;
      word-break:break-all;
    }
  </style>
  <script>
    var request = function(body) {
      return fetch('https://http1.idingdang.org/x', {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify(body)
      }).then((res) => res.text());
    }
  </script>
</head>

<body>
  <div id="search">
    <select id="br">
      <option>320</option>
      <option>192</option>
      <option>128</option>
    </select>
    <input type="text" id="keyword"/>
    <button onclick="search(0)">search</button>
    <button onclick="clearSearch()">clear</button>
  </div>
  <div id="search-result" class="log mb10 breakline">
  </div>
  <div id="aplayer"></div>
  <div>
    CDN: 
    <select id="cdnlist" onchange="cdnlistselect(this)">
      <option value="testingcf.jsdelivr.net">testingcf.jsdelivr.net</option>
      <option value="gcore.jsdelivr.net">gcore.jsdelivr.net</option>
      <option value="cdn.jsdelivr.net">cdn.jsdelivr.net</option>
    </select>
    <input type="text" id="cdn" value="testingcf.jsdelivr.net" />
  </div>
  <div class="mb10">
    <button onclick="clearCache()">清除缓存</button>
    <button onclick="clearLog()">清除日志</button>
  </div>
  <div id="log" class="log mb10 breakline"></div>
  <script>
    const cdnlistselect = function(selectObject) {
      document.getElementById('cdn').value = selectObject.value;
    }
    const cdn_url = function() {
      var cdn = document.getElementById('cdn').value;
      if (cdn == '') {
        cdn = 'cdn.jsdelivr.net';
      }
      return 'https://' + cdn + '/gh/xxzkid/xxzkid.github.io/public/';
    }
    
    var clearCache = function() {
      localforage.clear().then(function () {
        console.log('clear cache');
      });
    }

    var clearLog = function() {
      document.getElementById('log').innerText = '';
    }
    
    var fetchAudio = function (url, callback) {
      localforage.getItem(url).then(audio => {
        if (audio) {
          console.log(url + " exist");
          callback(audio);
        } else {
          console.log(url + " doesn't exist");
          fetch(url).then(res => res.blob())
            .then(blob => {
              const type = blob.type;
              console.log(url + ' fetch ok');
              blobToArrayBuffer(blob).then(buffer => {
                localforage
                  .setItem(url, { buffer, type })
                  .then(audio => {
                    callback(audio);
                  });
              });
            });
        }
      });
    }

    var arrayBufferToBlob = function (buffer, type) {
      return new Blob([buffer], { type: type });
    }

    var blobToArrayBuffer = function (blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.addEventListener("loadend", e => {
          resolve(reader.result);
        });
        reader.addEventListener("error", reject);
        reader.readAsArrayBuffer(blob);
      });
    }

    window.ap = new APlayer({
      container: document.getElementById('aplayer'),
      listFolded: false,
      listMaxHeight: 90,
      lrcType: 3,
      audio: [],
      customAudioType: {
        'custom': function (audioElement, audio, player) {
          var target_url = audio.url.indexOf('http:') > -1 || audio.url.indexOf('https:') > -1 ? audio.url : cdn_url() + audio.url;
          fetchAudio(target_url, function (_audio) {
            if (_audio.buffer) {
              _audio = arrayBufferToBlob(_audio.buffer, _audio.type);
            }
            audioElement.src = URL.createObjectURL(_audio);
            audioElement.play();
          })
        }
      }
    });

    var search = function(offset) {
      var keyword = document.getElementById('keyword').value;
      if (keyword == '') {
        return;
      }
      request({
        method: 'GET',
        url: 'https://neteast-cloud-music-api-heroku.vercel.app/search',
        params: {
          keywords: keyword,
          offset: offset,
          limit: 10
        }
      }).then((res) => {
        var result = JSON.parse(res);
        if (result.status == 200) {
          var data = result.data;
          if (data.code == 200) {
            if (data.result && data.result.songs) {
              var songs = data.result.songs;
              var html = '<ul>';
              for (var i = 0; i < songs.length; i++) {
                var song = songs[i];
                html += '<li>{name} {artists} <button onclick="addToPlaylist(this)" data-id="{id}" data-name="{name}" data-artist="{artists}">add</button></li>'
                .replace(/{id}/g, song.id).replace(/{name}/g, song.name).replace(/{artists}/g, song.artists[0].name);
              }
              html += '</ul>';
              if (data.result.hasMore) {
                if (offset - songs.length >= 0) {
                  html += '<button class="ml10" onclick="search(' + (offset - songs.length) + ')">prev</button>'
                }
                html += '<button class="ml10" onclick="search(' + (offset + songs.length) + ')">next</button>'
              }
              document.getElementById('search-result').innerHTML = html;
            } else {
              document.getElementById('search-result').innerText = '未找到结果';
            }
          } else {
            console.log('请求错误2');
          }
        } else {
          console.log('请求错误1');
          window.ap.notice('请求错误');
        }
      })
    }

    var clearSearch = function() {
      document.getElementById('keyword').value = '';
      document.getElementById('search-result').innerText = '';
    }

    var addToPlaylist = function(obj) {
      var id = obj.getAttribute('data-id');
      var name = obj.getAttribute('data-name');
      var artists = obj.getAttribute('data-artist');
      var br = document.getElementById('br').value;
      request({
        "method":"GET",
        "url": "https://neteast-cloud-music-api-heroku.vercel.app/song/url",
        "params": {
            "id": id,
            "br": (parseInt(br) * 1000) + ""
        }
      }).then((res) => {
        var result = JSON.parse(res);
        if (result.status == 200) {
          var data = result.data;
          if (data.code == 200) {
            if (data.data && data.data.length > 0 && data.data[0].url != null) {
              window.ap.list.add([{
                name: name, 
                artist: artists, 
                url: data.data[0].url.replace(/http\:/g, 'https:'), 
                cover: cdn_url() + './music/bg1.jpg', 
                lrc: '', 
                theme: '#ebd0c2',
                type: 'custom'
              }]);
              console.log(window.ap.list.audios.length - 1);
              window.ap.list.switch(window.ap.list.audios.length - 1);
              window.ap.play();
            } else {
              window.ap.notice('获取歌曲播放地址失败');
            }
          } else {
            console.log('请求错误2');
          }
        } else {
          console.log('请求错误1');
          window.ap.notice('请求错误');
        }
      })
    }
    
    function load_script(path) {
      var script_el = document.createElement('script');
      var new_path = '';
      if (path.indexOf('?') > 0) {
        new_path = path + '&_=' + (+new Date());
      } else {
        new_path = path + '?_=' + (+new Date());
      }
      script_el.src = new_path;
      document.getElementsByTagName('head')[0].appendChild(script_el);
      script_el.onload = function(e) {
        window.ap.list.add(window.audios);
      }
    }
    load_script('./song.js');
  </script>
</body>

</html>
