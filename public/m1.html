<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>APlayer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./APlayer.min.css">
  <script src="./APlayer.min.js"></script>
  
  <script src="./localforage.min.js"></script>
  <script src="./log.js"></script>
  <style>
    .log {
      color: gray;
      border: 1px solid #e9e9e9;
    }

    .mb10 {
      margin-bottom: 10px;
    }

    .breakline {
      word-wrap:break-word;
      word-break:break-all;
    }
  </style>
</head>

<body>
  <div id="aplayer"></div>
  <div class="mb10">
    <button onclick="clearCache()">清除缓存</button>
  </div>
  <div id="log" class="log mb10 breakline"></div>
  <script>
    var clearCache = function () {
      localforage.clear().then(function () {
        console.log('clear cache');
      });
    }
    
    var fetchAudio = function (url, callback) {
      localforage.getItem(url).then(audio => {
        if (audio) {
          console.log(url + " exist");
          callback(audio);
        } else {
          console.log(url + " doesn't exist");
          fetch(url).then(res => res.blob())
            .then(blob => {
              const type = blob.type;
              console.log(url + ' fetch ok');
              blobToArrayBuffer(blob).then(buffer => {
                localforage
                  .setItem(url, { buffer, type })
                  .then(audio => {
                    callback(audio);
                  });
              });
            });
        }
      });
    }

    var arrayBufferToBlob = function (buffer, type) {
      return new Blob([buffer], { type: type });
    }

    var blobToArrayBuffer = function (blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.addEventListener("loadend", e => {
          resolve(reader.result);
        });
        reader.addEventListener("error", reject);
        reader.readAsArrayBuffer(blob);
      });
    }

    window.ap = new APlayer({
      container: document.getElementById('aplayer'),
      listFolded: false,
      listMaxHeight: 500,
      lrcType: 3,
      audio: [],
      customAudioType: {
        'custom': function (audioElement, audio, player) {
          fetchAudio(audio.url, function (_audio) {
            if (_audio.buffer) {
              _audio = arrayBufferToBlob(_audio.buffer, _audio.type);
            }
            audioElement.src = URL.createObjectURL(_audio);
          })
        }
      }
    });
  </script>
  <script>
    function load_script(path) {
      var script_el = document.createElement('script');
      var new_path = '';
      if (path.indexOf('?') > 0) {
        new_path = path + '&_=' + (+new Date());
      } else {
        new_path = path + '?_=' + (+new Date());
      }
      script_el.src = new_path;
      document.getElementsByTagName('head')[0].appendChild(script_el);
      script_el.onload = function(e) {
        window.ap.list.add(window.audios);
      }
    }
    load_script('./song.js');
  </script>
</body>

</html>
